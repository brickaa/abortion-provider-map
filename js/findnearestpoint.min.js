/* findnearestpoint - 0.0.1 2013-10-09 */
!function(a,b,c){function d(a){if(!a)return a;for(var b=1,c=arguments.length;c>b;b++){var d=arguments[b];if(d)for(var e in d)a[e]=d[e]}return a}function e(a){var b=a[0]*g.rad,c=a[1]*g.rad,d=Math.cos(c);return[d*Math.cos(b),Math.sin(c),d*Math.sin(b)]}var f=a.FindNearestPoint={};f.VERSION="0.0.1";var g=f.CONSTANTS={rad:Math.PI/180,invEarthDiameter:1/12742018};b.prototype.forEach||(b.prototype.forEach=function(a,b){"use strict";var c,d;if(null==this)throw new TypeError("this is null or not defined");var e,f=Object(this),g=f.length>>>0;if("[object Function]"!=={}.toString.call(a))throw new TypeError(a+" is not a function");for(arguments.length>=2&&(c=b),d=0;g>d;)d in f&&(e=f[d],a.call(c,e,d,f)),d++});var h=f.Points=function(a){this.pointCollection=a,this.init()};d(h.prototype,{init:function(){this.spherical2cartesian(),this.densityObject=this.buildrec()},spherical2cartesian:function(){var a=this.cartesianPoints=[];this.pointCollection.forEach(function(b){a.push({position:e(b.position),data:b.data})})},buildrec:function(a,b){if(a===c&&(a=this.cartesianPoints),b===c&&(b=0),0===a.length)return null;if(1===a.length)return a[0];var d=b%a[0].position.length;a.sort(function(a,b){return a.position[d]-b.position[d]});var e=Math.floor(.5*a.length);return b+=1,{axis:d,split:a[e].position[d],left:this.buildrec(a.slice(0,e),b),right:this.buildrec(a.slice(e),b)}},findNearestPoints:function(a,b,c){var d=this.densityObject;a=e(a),c=c>0?2*Math.sin(c*g.invEarthDiameter):Number.POSITIVE_INFINITY;var f=[];if(null===d||0>=b)return f;for(var h,i=[d,0];i.length;)if(h=i.pop(),d=i.pop(),!(h>c||f.length===b&&f[f.length-1].dist<h*h)){for(;Object.prototype.hasOwnProperty.call(d,"axis");)a[d.axis]<d.split?(i.push(d.right,d.split-a[d.axis]),d=d.left):(i.push(d.left,a[d.axis]-d.split),d=d.right);h=this.distance(a,d.position),c*c>=h&&this.insert({object:d,dist:h},f),f.length>b&&f.pop()}var j=[];return f.forEach(function(a){j.push(a.object.data)}),j},distance:function(a,b){for(var c,d=Math.min(a.length,b.length),e=0;d--;)c=b[d]-a[d],e+=c*c;return e},insert:function(a,b){var c=this.search(a,b);0>c&&(c=-(c+1)),b.splice(c,0,a)},search:function(a,b){for(var c,d,e=0,f=b.length-1;f>=e;)if(c=Math.floor((e+f)/2),d=b[c].dist-a.dist,0>d)e=c+1;else{if(!(d>0))return c;f=c-1}return-(e+1)}})}(window,Array);